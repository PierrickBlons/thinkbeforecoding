<p><a href="http://thinkbeforecoding.com/post/2009/10/30/Event-Sourcing-and-CQRS%2C-Now-%21" target="_blank">Last time</a>, we started a very basic Event Sourcing/Domain Events/CQRS framework. <em>Be careful, I made an edit in the nested DomainEvents+Handler&lt;T&gt;.Handles&lt;E&gt;() method, the AggregateRoot.Replay method will not work as is, but we won’t need it.</em></p>
<p>We’ll build an equally simplistic application for personal library management.</p>
<p>The Ubiquitous Language will be minimal.</p>
<p>A <strong>Book</strong> can be <strong>Registered</strong> with a <strong>Title</strong> and an <strong>ISBN</strong>.</p>
<p>A <strong>Book</strong> can be <strong>Lent</strong> to a <strong>Borrower</strong> at some <strong>Date</strong> for an <strong>Expected Time Span</strong>.</p>
<p>A <strong>Book</strong> can then be <strong>Returned</strong>. If it is <strong>Returned</strong> after <strong>Expected Time Span</strong>, the return is <strong>Late</strong>.</p>
<p>That’s enough for our first try.</p>
<h2>The Command Context</h2>
<h3>The State Change Events</h3>
<p>Here is the code for the three events that we found in the Ubiquitous language:</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">BookRegistered</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">BookId</span> Id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: blue">string</span> Title;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: blue">string</span> Isbn;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> BookRegistered(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">string</span> title, <span style="COLOR: blue">string</span> isbn)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Id = id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Title = title;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Isbn = isbn;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">BookLent</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">BookId</span> Id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: blue">string</span> Borrower;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">DateTime</span> Date;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">TimeSpan</span> ExpectedDuration;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> BookLent(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">string</span> borrower, <span style="COLOR: #2b91af">DateTime</span> date, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">TimeSpan</span> expectedDuration)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Id = id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Borrower = borrower;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date = date;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExpectedDuration = expectedDuration;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">BookReturned</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">BookId</span> Id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: blue">string</span> By;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">TimeSpan</span> After;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: blue">bool</span> Late;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> BookReturned(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">string</span> @by, <span style="COLOR: #2b91af">TimeSpan</span> after, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">bool</span> late)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Id = id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; By = by;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; After = after;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Late = late;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>These events will usually be serialized to the event storage and on a service bus, but here everything runs in memory.</p>
<h3>The Book Aggregate Root</h3>
<p>The book will need to be referenced by an identity in our system. We’ll hide a Guid behind a BookId struct :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">struct</span> <span style="COLOR: #2b91af">BookId</span> : <span style="COLOR: #2b91af">IEquatable</span>&lt;<span style="COLOR: #2b91af">BookId</span>&gt;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: #2b91af">Guid</span> id;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> BookId(<span style="COLOR: #2b91af">Guid</span> id) { <span style="COLOR: blue">this</span>.id = id; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: #2b91af">BookId</span> NewBookId() { <span style="COLOR: blue">return</span> <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookId</span>(<span style="COLOR: #2b91af">Guid</span>.NewGuid()); }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">bool</span> Equals(<span style="COLOR: #2b91af">BookId</span> other) { <span style="COLOR: blue">return</span> other.id.Equals(id); }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">override</span> <span style="COLOR: blue">bool</span> Equals(<span style="COLOR: blue">object</span> obj)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (ReferenceEquals(<span style="COLOR: blue">null</span>, obj)) <span style="COLOR: blue">return</span> <span style="COLOR: blue">false</span>;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (obj.GetType() != <span style="COLOR: blue">typeof</span>(<span style="COLOR: #2b91af">BookId</span>)) <span style="COLOR: blue">return</span> <span style="COLOR: blue">false</span>;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">return</span> Equals((<span style="COLOR: #2b91af">BookId</span>)obj);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">override</span> <span style="COLOR: blue">int</span> GetHashCode() { <span style="COLOR: blue">return</span> id.GetHashCode(); }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>Now, the Book class itself :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0"><span style="COLOR: blue">&nbsp; public</span> <span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">Book</span> : AggregateRoot&lt;<span style="COLOR: #2b91af">BookId</span>&gt;</p>
<p style="MARGIN: 0">&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">BookId</span> id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">string</span> title;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">string</span> isbn;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">string</span> borrower;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: #2b91af">DateTime</span> date;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: #2b91af">TimeSpan</span> expectedDuration;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> Book(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: #2b91af">IEnumerable</span>&lt;<span style="COLOR: blue">object</span>&gt; events)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">this</span>.id = id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">foreach</span> (<span style="COLOR: blue">dynamic</span> @event <span style="COLOR: blue">in</span> events)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Apply(@event);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> Book(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">string</span> title, <span style="COLOR: blue">string</span> isbn)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">this</span>.id = id;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> @event = <span style="COLOR: blue">new</span> BookRegistered(id, title, isbn);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Apply(@event);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Append(@event);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">override</span> <span style="COLOR: #2b91af">BookId</span> Id { <span style="COLOR: blue">get</span> { <span style="COLOR: blue">return</span> id; } }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> Lend(<span style="COLOR: blue">string</span> borrower, <span style="COLOR: #2b91af">DateTime</span> date, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">TimeSpan</span> expectedDuration)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (<span style="COLOR: blue">this</span>.borrower != <span style="COLOR: blue">null</span>)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">throw</span> <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">InvalidOperationException</span>(<span style="COLOR: #a31515">"The book is already lent."</span>);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> @event = </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">new</span> BookLent(id, borrower, date, expectedDuration);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Apply(@event);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Append(@event);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> Return(<span style="COLOR: #2b91af">DateTime</span> returnDate)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (borrower == <span style="COLOR: blue">null</span>)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">throw</span> <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">InvalidOperationException</span>(<span style="COLOR: #a31515">"The book has not been lent."</span>);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (returnDate &lt; date)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">throw</span> <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">ArgumentException</span>(</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #a31515">"The book cannot be returned before being lent."</span>);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> actualDuration = returnDate - date;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> @event = <span style="COLOR: blue">new</span> BookReturned(</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; id, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; borrower, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; actualDuration,</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; actualDuration &gt; expectedDuration);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Apply(@event);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Append(@event);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">void</span> Apply(BookRegistered @event)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; title = @event.Title;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; isbn = @event.Isbn;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">void</span> Apply(BookLent @event)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; borrower = @event.Borrower;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; date = @event.Date;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; expectedDuration = @event.ExpectedDuration;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">void</span> Apply(BookReturned @event)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; borrower = <span style="COLOR: blue">null</span>;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp; }</p>
</div>
<p>The class implements AggregateRoot&lt;BookId&gt; and so provides an explicitly implemented UncommittedEvents property.</p>
<p>The first .ctor is used to load the Aggregate Root, the second one is used to build a new Aggregate Root.</p>
<p>The public methods (Lend and Return) are the commands on the Aggregate Root as defined in the Ubiquitous Language.</p>
<p>The structure is always the same :</p>
<ol>
<li>Validate arguments and state </li>
<li>Prepare state transition using domain logic </li>
<li>Apply state transition (no domain logic should happen here) </li>
<li>Append state transition to uncommitted events </li>
</ol>
<p>The first .ctor uses dynamic to dispatch each event object on the corresponding specific Apply method. In case you implement the pattern is previous C# version, it is advised to provide a Replay method in the base class that will perform the dynamic dispatch based on reflection.</p>
<p>That’s all for the entity. No ORM, no mapping… easy.</p>
<h3>The Repository</h3>
<p>It is often clearer to provide a specific repository interface that exposes only available methods. With event sourcing, it’s not that useful… we’ll write it anyway in case you’d like to use dependency injection. The interface is part of the domain and should be in the same assembly as the entity and the events.</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">interface</span> <span style="COLOR: #2b91af">IBookRepository</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">void</span> Add(<span style="COLOR: #2b91af">Book</span> book);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">Book</span> <span style="COLOR: blue">this</span>[<span style="COLOR: #2b91af">BookId</span> id] { <span style="COLOR: blue">get</span>; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>The implementation will simply derive from the Repository base class, it can be in the application assembly.</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">internal</span> <span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">BookRepository</span> : </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Repository&lt;<span style="COLOR: #2b91af">BookId</span>, <span style="COLOR: #2b91af">Book</span>&gt;,</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">IBookRepository</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">protected</span> <span style="COLOR: blue">override</span> <span style="COLOR: #2b91af">Book</span> CreateInstance(<span style="COLOR: #2b91af">BookId</span> id, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">IEnumerable</span>&lt;<span style="COLOR: blue">object</span>&gt; events)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">return</span> <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">Book</span>(id, events);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>Add and the indexer are implemented by the base class. The only thing to provide is a way to instantiate the class with expected parameters.</p>
<p>We could use Activator.CreateInstance or reflection to provide a generic implementation. I choose to make it simpler to read.</p>
<h2>The Query context</h2>
<h3>The Report Database</h3>
<p>We’ll mimic a reporting table of book lent state :</p>
<p>This would be the data returned from table rows :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">BookState</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: #2b91af">BookId</span> Id { <span style="COLOR: blue">get</span>; <span style="COLOR: blue">set</span>; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">string</span> Title { <span style="COLOR: blue">get</span>; <span style="COLOR: blue">set</span>; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">bool</span> Lent { <span style="COLOR: blue">get</span>; <span style="COLOR: blue">set</span>; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>And this will hide the data table implementation :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">interface</span> <span style="COLOR: #2b91af">IBookStateQuery</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">IEnumerable</span>&lt;<span style="COLOR: #2b91af">BookState</span>&gt; GetBookStates();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">BookState</span> GetBookState(<span style="COLOR: #2b91af">BookId</span> id);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">IEnumerable</span>&lt;<span style="COLOR: #2b91af">BookState</span>&gt; GetLentBooks();</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">void</span> AddBookState(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">string</span> title);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">void</span> SetLent(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">bool</span> lent);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>We can simply query data to report in the UI, and update data state.</p>
<p>Implementation will be in memory for now :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0"><span style="COLOR: blue">&nbsp;&nbsp;&nbsp; class</span> <span style="COLOR: #2b91af">BookStateQuery</span> : <span style="COLOR: #2b91af">IBookStateQuery</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">Dictionary</span>&lt;<span style="COLOR: #2b91af">BookId</span>, <span style="COLOR: #2b91af">BookState</span>&gt; states = </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">Dictionary</span>&lt;<span style="COLOR: #2b91af">BookId</span>, <span style="COLOR: #2b91af">BookState</span>&gt;();</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: #2b91af">IEnumerable</span>&lt;<span style="COLOR: #2b91af">BookState</span>&gt; GetBookStates()</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">return</span> states.Values;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: #2b91af">BookState</span> GetBookState(<span style="COLOR: #2b91af">BookId</span> id)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">return</span> states[id];</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: #2b91af">IEnumerable</span>&lt;<span style="COLOR: #2b91af">BookState</span>&gt; GetLentBooks()</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">return</span> states.Values.Where(b =&gt; b.Lent);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> AddBookState(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">string</span> title)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> state = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookState</span> { Id = id, Title = title };</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; states.Add(id, state);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> SetLent(<span style="COLOR: #2b91af">BookId</span> id, <span style="COLOR: blue">bool</span> lent)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; states[id].Lent = lent;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>The important point here is that no domain logic occurs.</p>
<p>A RDBMS implementation could use an ORM or simply build DTOs from a DataReader.</p>
<h2>The event handlers</h2>
<p>We can now denormalize domain states to the reporting database using an event handler :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0"><span style="COLOR: blue">&nbsp;&nbsp;&nbsp; class</span> <span style="COLOR: #2b91af">BookStateHandler</span> :</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; Handles&lt;<span style="COLOR: #2b91af">BookRegistered</span>&gt;,</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; Handles&lt;<span style="COLOR: #2b91af">BookLent</span>&gt;,</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; Handles&lt;<span style="COLOR: #2b91af">BookReturned</span>&gt;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">readonly</span> <span style="COLOR: #2b91af">IBookStateQuery</span> stateQuery;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> BookStateHandler(<span style="COLOR: #2b91af">IBookStateQuery</span> stateQuery)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">this</span>.stateQuery = stateQuery;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> Handle(<span style="COLOR: #2b91af">BookRegistered</span> @event)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stateQuery.AddBookState(@event.Id, @event.Title);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> Handle(<span style="COLOR: #2b91af">BookLent</span> @event)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">Console</span>.WriteLine(<span style="COLOR: #a31515">"Book lent to {0}"</span>, @event.Borrower);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stateQuery.SetLent(@event.Id, <span style="COLOR: blue">true</span>);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> Handle(<span style="COLOR: #2b91af">BookReturned</span> @event)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">Console</span>.WriteLine(<span style="COLOR: #a31515">"Book returned by {0}"</span>, @event.By);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stateQuery.SetLent(@event.Id, <span style="COLOR: blue">false</span>);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>The Console.WriteLine are here to view when things happen, you would usually not use it in your production code. Logging this would not provide much benefits since all the events are already stored in the EventStorage.</p>
<p>Using this handler, the IBookStateQuery will be up to date with current Command Context state. In an asynchronous environment, this is where eventual consistency is introduced.</p>
<p>We will also add a service that will notify when a user returned a book too late :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">class</span> <span style="COLOR: #2b91af">LateReturnNotifier</span> :</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; Handles&lt;<span style="COLOR: #2b91af">BookReturned</span>&gt;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> Handle(<span style="COLOR: #2b91af">BookReturned</span> @event)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (@event.Late)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">Console</span>.WriteLine(<span style="COLOR: #a31515">"{0} was late"</span>, @event.By);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>Here again, no domain logic, we just do the infrastructure stuff, usually sending an email or a SMS.</p>
<h2>View it in Action</h2>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0"><span style="COLOR: blue">&nbsp;&nbsp;&nbsp; class</span> <span style="COLOR: #2b91af">Program</span></p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">static</span> <span style="COLOR: blue">void</span> Main(<span style="COLOR: blue">string</span>[] args)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ISessionFactory factory = <span style="COLOR: blue">new</span> SessionFactory(<span style="COLOR: blue">new</span> EventStorage());&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">IBookStateQuery</span> query = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookStateQuery</span>();</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DomainEvents.RegisterHanlder(() =&gt; <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookStateHandler</span>(query));</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DomainEvents.RegisterHanlder(() =&gt; <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">LateReturnNotifier</span>());</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> bookId = <span style="COLOR: #2b91af">BookId</span>.NewBookId();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: blue">var</span> session = factory.OpenSession())</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> books = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookRepository</span>();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; books.Add(<span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">Book</span>(bookId, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #a31515">"The Lord of the Rings"</span>, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #a31515">"0-618-15396-9"</span>));</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.SubmitChanges();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowBooks(query);</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: blue">var</span> session = factory.OpenSession())</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> books = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookRepository</span>();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> book = books[bookId];</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; book.Lend(<span style="COLOR: #a31515">"Alice"</span>, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">DateTime</span>(2009, 11, 2), </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">TimeSpan</span>.FromDays(14));</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.SubmitChanges();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowBooks(query);</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: blue">var</span> session = factory.OpenSession())</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> books = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookRepository</span>();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> book = books[bookId];</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; book.Return(<span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">DateTime</span>(2009, 11, 8));</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.SubmitChanges();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowBooks(query);</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: blue">var</span> session = factory.OpenSession())</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> books = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookRepository</span>();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> book = books[bookId];</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; book.Lend(<span style="COLOR: #a31515">"Bob"</span>, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">DateTime</span>(2009, 11, 9), </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">TimeSpan</span>.FromDays(14));</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.SubmitChanges();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowBooks(query);</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: blue">var</span> session = factory.OpenSession())</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> books = <span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">BookRepository</span>();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">var</span> book = books[bookId];</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; book.Return(<span style="COLOR: blue">new</span> <span style="COLOR: #2b91af">DateTime</span>(2010, 03, 1));</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session.SubmitChanges();</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowBooks(query);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">static</span> <span style="COLOR: blue">void</span> ShowBooks(<span style="COLOR: #2b91af">IBookStateQuery</span> query)</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">foreach</span> (<span style="COLOR: blue">var</span> state <span style="COLOR: blue">in</span> query.GetBookStates())</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #2b91af">Console</span>.WriteLine(<span style="COLOR: #a31515">"{0} is {1}."</span>, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state.Title, </p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state.Lent ? <span style="COLOR: #a31515">"lent"</span> : <span style="COLOR: #a31515">"home"</span>);</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0">&nbsp;&nbsp;&nbsp; }</p>
</div>
<p>We start by instantiating storage for the command context (the ISessionFactory) and the query context (the <span style="COLOR: #2b91af">IBookStateQuery</span>). In production you’ll use persistent storages (a persistent event storage and a RDBMS). I highly recommend using a Dependency Injection Container for real size projects.</p>
<p>Then we wire the handlers on domain events.</p>
<p>The application can start.</p>
<ul>
<li>We register a book in the library.</li>
<li>We lend it to Alice on 2009-11-02 for 14 days</li>
<li>She returns it on 2009-11-08, she’s on time</li>
<li>We lend it to Bob on 2009-11-09 for 14 days,</li>
<li>He returns it on 2010-03-01, he’s late</li>
</ul>
<p>The output is the following :</p>
<div style="BORDER-BOTTOM: #a0a0a0 1px solid; BORDER-LEFT: #a0a0a0 1px solid; FONT-FAMILY: courier new; BACKGROUND: #f8f8f8; COLOR: black; FONT-SIZE: 10pt; BORDER-TOP: #a0a0a0 1px solid; BORDER-RIGHT: #a0a0a0 1px solid">
<p style="MARGIN: 0">The Lord of the Rings <span style="COLOR: blue">is</span> home.&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written from state</span></p>
<p style="MARGIN: 0">Book lent to Alice&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written by the book state handler</span></p>
<p style="MARGIN: 0">The Lord of the Rings <span style="COLOR: blue">is</span> lent.&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written from state</span></p>
<p style="MARGIN: 0">Book returned by Alice&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written by the book state handler</span></p>
<p style="MARGIN: 0">The Lord of the Rings <span style="COLOR: blue">is</span> home.&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written from state</span></p>
<p style="MARGIN: 0">Book lent to Bob&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written by the book state handler</span></p>
<p style="MARGIN: 0">The Lord of the Rings <span style="COLOR: blue">is</span> lent.&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written from state</span></p>
<p style="MARGIN: 0">Book returned by Bob&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written by the book state handler</span></p>
<p style="MARGIN: 0">Bob was late&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written by the late return notifier</span></p>
<p style="MARGIN: 0">The Lord of the Rings <span style="COLOR: blue">is</span> home.&nbsp;&nbsp;&nbsp; <span style="COLOR: green">// written from state</span></p>
</div>
<p>We have here a clear separation between Command that handles the domain logic and Query that handles presentation logic.</p>
<p>Have fun. Questions and remarks expected !</p>