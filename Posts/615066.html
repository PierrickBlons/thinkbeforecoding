<p>In the <a href="http://thinkbeforecoding.com/post/2009/11/03/Event-Sourcing-and-CQRS-Dispatch-options" target="_blank">part one comments</a>, Clement suggested a more efficient solution than registering handler in constructor.</p>
<p>&nbsp;</p>
<p>The proposed solution is to have a RegisterAllEvents virtual method in which event handler registration would occur. This method is a method instance to have access to this but will be called only once per class. The registration use Expression&lt;Action&lt;T&gt;&gt; to access the expression tree and extract the method info of the handler. This enables type checking, make R# happy – no unused methods – and make reflection not too painful.</p>
<p>&nbsp;</p>
<p><strong>Good solution.</strong></p>
<p>&nbsp;</p>
<p>I didn't go that far because with Event Sourcing, you usually keep aggregates in memory, so aggregates are instantiated once per service lifetime.   <br />I just crafted a small performance test : </p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<pre style="line-height: normal; width: auto; font-family: ; background: white; overflow: visible"><span style="color: ">using</span> System;<br /><span style="color: ">using</span> System.Collections.Generic;<br /><span style="color: ">using</span> System.Diagnostics;<br /> <br /><span style="color: ">namespace</span> AggregatePerfTest<br />{<br />&nbsp;&nbsp;&nbsp; <span style="color: ">class</span>&nbsp;<span style="color: ">Program</span><br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">static</span>&nbsp;<span style="color: ">void</span> Main(<span style="color: ">string</span>[] args)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">var</span> watch = <span style="color: ">new</span>&nbsp;<span style="color: ">Stopwatch</span>();<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">const</span>&nbsp;<span style="color: ">int</span> count = 10000000;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">Guid</span> id = <span style="color: ">Guid</span>.NewGuid();<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; watch.Start();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">for</span> (<span style="color: ">int</span> i = 0; i &lt; count; i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">new</span>&nbsp;<span style="color: ">AggregateRegisteredOncePerInstance</span>(id);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; watch.Stop();<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">Console</span>.WriteLine(watch.Elapsed.TotalMilliseconds);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; watch.Reset();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; watch.Start();<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">for</span> (<span style="color: ">int</span> i = 0; i &lt; count; i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">new</span>&nbsp;<span style="color: ">AggregateRegisteredOncePerClass</span>(id);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; watch.Stop();<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">Console</span>.WriteLine(watch.Elapsed.TotalMilliseconds);<br />&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /> <br />&nbsp;&nbsp;&nbsp; <span style="color: ">public</span>&nbsp;<span style="color: ">class</span>&nbsp;<span style="color: ">AggregateRegisteredOncePerClass</span><br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">readonly</span>&nbsp;<span style="color: ">Guid</span> id;<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">static</span>&nbsp;<span style="color: ">readonly</span>&nbsp;<span style="color: ">object</span> ClassInitLock = <span style="color: ">new</span>&nbsp;<span style="color: ">object</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">static</span>&nbsp;<span style="color: ">bool</span> initialized;<br /> <br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">public</span> AggregateRegisteredOncePerClass(<span style="color: ">Guid</span> id)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">this</span>.id = id;<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">lock</span> (ClassInitLock)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">if</span> (!initialized)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; initialized = <span style="color: ">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">// registration happens only once here</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">public</span>&nbsp;<span style="color: ">Guid</span> Id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">get</span> { <span style="color: ">return</span> id; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /> <br />&nbsp;&nbsp;&nbsp; <span style="color: ">public</span>&nbsp;<span style="color: ">class</span>&nbsp;<span style="color: ">AggregateRegisteredOncePerInstance</span><br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">readonly</span>&nbsp;<span style="color: ">Guid</span> id;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">readonly</span>&nbsp;<span style="color: ">Dictionary</span>&lt;<span style="color: ">Type</span>, <span style="color: ">dynamic</span>&gt; handlers = <br /><span style="color: ">                         new</span>&nbsp;<span style="color: ">Dictionary</span>&lt;<span style="color: ">Type</span>, <span style="color: ">dynamic</span>&gt;(5);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">public</span> AggregateRegisteredOncePerInstance(<span style="color: ">Guid</span> id)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">this</span>.id = id;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Register&lt;<span style="color: ">int</span>&gt;(OnSomethingHappened);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Register&lt;<span style="color: ">double</span>&gt;(OnSomethingHappened);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Register&lt;<span style="color: ">float</span>&gt;(OnSomethingHappened);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Register&lt;<span style="color: ">long</span>&gt;(OnSomethingHappened);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">public</span>&nbsp;<span style="color: ">Guid</span> Id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">get</span> { <span style="color: ">return</span> id; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">public</span>&nbsp;<span style="color: ">void</span> DoSomething()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Apply(1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">void</span> OnSomethingHappened(<span style="color: ">int</span> message) { }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">void</span> OnSomethingHappened(<span style="color: ">double</span> message){ }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">void</span> OnSomethingHappened(<span style="color: ">float</span> message) { }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">private</span>&nbsp;<span style="color: ">void</span> OnSomethingHappened(<span style="color: ">long</span> message) { }<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">protected</span>&nbsp;<span style="color: ">void</span> Apply&lt;T&gt;(T @event)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; handlers[<span style="color: ">typeof</span> (T)](@event);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: ">protected</span>&nbsp;<span style="color: ">void</span> Register&lt;T&gt;(<span style="color: ">Action</span>&lt;T&gt; handler)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; handlers.Add(<span style="color: ">typeof</span>(T), handler);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />}</pre>
<p>The code is straight forward, I just created two aggregate classes :</p>
<ul>
<li>one with registration in .ctor based on this post code </li>
<li>one without any registration at all, considering that doing it once is the same as not doing it for large numbers, but I added a lock section with a boolean check to simulate what will done on each instance creation.</li>
</ul>
<p>I created 10.000.000 instances for each, and you get:</p>
<ul>
<li>3978ms for the one with .ctor registrations,</li>
<li>377 ms for the one without.</li>
</ul>
<p>It's true that it makes a difference. But how many aggregates do you have in your system ?</p>
<p>&nbsp;</p>
<p>With 10.000 aggregate you're still under 8ms. I think you can afford that.</p>
<p>&nbsp;</p>
<p>This is then a trade-off between performance and simplicity :</p>
<ul>
<li>If you have very large numbers, go for expression tree parsing, class lock management etc.</li>
<li>In any other situation I recommend using registration in .ctor that makes the code easy to implement in approximately 5min. </li>
</ul>