<p>Yeah it's christmas time again, and santa's elves are quite busy.</p>
<p>And when I say busy, I don't mean:</p>
<p><img src="http://s.hswstatic.com/gif/santa-claus-stories-ga-the-tiny-elf-8b.jpg" alt="Santa's elves" /></p>
<p>I mean busy like this:</p>
<p><img src="https://theredphoenix.files.wordpress.com/2013/12/amazon-warehouse-assemblyline.jpg" alt="Santa's elves" /></p>
<p>So they decided to build some automation productivity tools,
and they choose Santa's favorite language to do the job:</p>
<p><strong>F#</strong> of course !</p>
<h2>F# scripting</h2>
<p>No body would seriously use a compiled language for automation tools. Requiring compilation or a CI server
for this kind of things usually kills motivation.</p>
<p>Of course it is possible to write bash/batch files but the syntax if fugly once you start to make more advanced
tools.</p>
<p>Python, JavaScript, Ruby or PowerShell are cool, but you end up as often with scripted languages with dynamic typing which you'll
come to regret when you have to maintain it on the long term.</p>
<p>F# is a staticaly typed language that can be easily scripted. Type inference make it feel like shorter JavaScript but
with far higher safety !</p>
<p>Writing F# script is easy and fast. Test it from the command line:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">vim</span> <span class="i">test</span><span class="o">.</span><span class="i">fsx</span>
</code></pre></td>
</tr>
</table>
<p>Then write:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="f">printfn</span> <span class="s">&quot;Merry Christmas !&quot;</span>
</code></pre></td>
</tr>
</table>
<p>press <code>:q</code> to exit</p>
<p>now launch it on linux with:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">fsharpi</span> <span class="o">--</span><span class="i">exec</span> <span class="i">test</span><span class="o">.</span><span class="i">fsx</span>
</code></pre></td>
</tr>
</table>
<p>or on windows:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">fsianycpu</span> <span class="o">--</span><span class="i">exec</span> <span class="i">test</span><span class="o">.</span><span class="i">fsx</span>
</code></pre></td>
</tr>
</table>
<p>Excellent.</p>
<p>The only problem is that typing the <code>fshapi --exec</code> this is a bit tedious.</p>
<h2>Bash/Batch to the rescue</h2>
<p>We can create a bash/batch script to puth in the path that will launch the script (for linux):</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">vim</span> <span class="i">test</span>
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">fsharpi</span> <span class="o">--</span><span class="i">exec</span> <span class="i">test</span><span class="o">.</span><span class="i">fsx</span>
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">chmod</span> <span class="o">+</span><span class="i">x</span> <span class="i">test</span>
</code></pre></td>
</tr>
</table>
<p>or one windows</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">vim</span> <span class="i">test</span><span class="o">.</span><span class="i">cmd</span>
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">fsianycpu</span> <span class="o">--</span><span class="i">exec</span> <span class="i">test</span><span class="o">.</span><span class="i">fsx</span>    
</code></pre></td>
</tr>
</table>
<p>Done !</p>
<p>Better, but now we need to write a bash and/or a batch script for each F# script.</p>
<h2>fck bash/batch dispatcher FTW !</h2>
<p>We create a fck file (don't forget to chmod +x it) that takes a command</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">#!/usr/bin/env bash</span>


# <span class="i">fck</span> <span class="i">tool</span> <span class="i">path</span>
<span class="i">fckpath</span><span class="o">=$</span>(<span class="i">readlink</span> <span class="o">-</span><span class="i">f</span> <span class="s">&quot;$0&quot;</span>)
# <span class="i">fck</span> <span class="i">tool</span> <span class="i">dir</span>
<span class="i">dir</span><span class="o">=$</span>(<span class="i">dirname</span> <span class="o">$</span><span class="i">fckpath</span>)
<span class="i">script</span><span class="o">=</span><span class="s">&quot;$dir/fck-cmd/fck-$1.fsx&quot;</span>
<span class="i">shell</span><span class="o">=</span><span class="s">&quot;$dir/fck-cmd/fck-$1.sh&quot;</span>
<span class="i">cmd</span><span class="o">=</span><span class="s">&quot;$1&quot;</span>
<span class="i">shift</span>

# <span class="i">packages</span> <span class="k">if</span> <span class="i">needed</span>
<span class="k">if</span> [ <span class="o">!</span> <span class="o">-</span><span class="i">d</span> <span class="s">&quot;$dir/fck-cmd/packages&quot;</span> ]
<span class="k">then</span>
<span class="i">pushd</span> <span class="s">&quot;$dir/fck-cmd&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="i">dev</span><span class="o">/</span><span class="k">null</span>
    <span class="i">mono</span> <span class="s">&quot;$dir/fck-cmd/.paket/paket.bootstrapper.exe&quot;</span> <span class="o">--</span><span class="i">run</span> <span class="i">restore</span>
<span class="i">popd</span> <span class="o">&gt;</span> <span class="o">/</span><span class="i">dev</span><span class="o">/</span><span class="k">null</span>
<span class="i">fi</span>

# <span class="i">script</span> <span class="i">command</span> <span class="k">if</span> <span class="i">it</span> <span class="i">exists</span>
<span class="k">if</span> [ <span class="o">-</span><span class="i">e</span> <span class="o">$</span><span class="i">script</span> ]
<span class="k">then</span>
    <span class="i">mono</span> <span class="s">&quot;$dir/fck-cmd/packages/FAKE/tools/FAKE.exe&quot;</span> <span class="s">&quot;$script&quot;</span> <span class="o">--</span> <span class="o">$@</span>

# <span class="i">shell</span> <span class="i">command</span> <span class="k">if</span> <span class="i">it</span> <span class="i">exists</span>
<span class="k">elif</span> [ <span class="o">-</span><span class="i">e</span> <span class="o">$</span><span class="i">shell</span> ]
<span class="k">then</span>
    <span class="i">eval</span> <span class="o">$</span><span class="i">shell</span> <span class="o">$@</span>

# <span class="i">help</span>
<span class="k">else</span>
<span class="i">pushd</span> <span class="s">&quot;$dir/fck-cmd&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="i">dev</span><span class="o">/</span><span class="k">null</span>
    <span class="i">mono</span> <span class="s">&quot;$dir/fck-cmd/packages/FAKE/tools/FAKE.exe&quot;</span> <span class="s">&quot;$dir/fck-cmd/fck-help.fsx&quot;</span> <span class="o">--</span> <span class="o">$</span><span class="i">cmd</span> <span class="o">$@</span>
<span class="i">popd</span> <span class="o">&gt;</span> <span class="o">/</span><span class="i">dev</span><span class="o">/</span><span class="k">null</span>
<span class="i">fi</span>
</code></pre></td>
</tr>
</table>
<p>and the batch version:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="o">@</span><span class="i">echo</span> <span class="i">off</span>
<span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">set</span> <span class="i">encoding</span><span class="o">=</span><span class="i">utf</span><span class="o">-</span><span class="n">8</span>

<span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">set</span> <span class="i">dir</span><span class="o">=%~</span><span class="i">dp0</span>
<span onmouseout="hideTip(event, 'fs2', 4)" onmouseover="showTip(event, 'fs2', 4)" class="i">set</span> <span class="i">cmd</span><span class="o">=%</span><span class="n">1</span>
<span onmouseout="hideTip(event, 'fs2', 5)" onmouseover="showTip(event, 'fs2', 5)" class="i">set</span> <span class="i">script</span><span class="o">=</span><span class="s">&quot;%dir%\fck-cmd\fck-%cmd%.fsx&quot;</span>
<span onmouseout="hideTip(event, 'fs2', 6)" onmouseover="showTip(event, 'fs2', 6)" class="i">set</span> <span class="i">batch</span><span class="o">=</span><span class="s">&quot;%dir%\fck-cmd\fck-%cmd%.cmd&quot;</span>
<span class="i">shift</span>

<span onmouseout="hideTip(event, 'fs2', 7)" onmouseover="showTip(event, 'fs2', 7)" class="i">set</span> <span class="s">&quot;args=&quot;</span>
<span class="o">:</span><span class="i">parse</span>
<span class="k">if</span> <span class="s">&quot;%~1&quot;</span> <span class="i">neq</span> <span class="s">&quot;&quot;</span> (
  <span onmouseout="hideTip(event, 'fs2', 8)" onmouseover="showTip(event, 'fs2', 8)" class="i">set</span> <span class="i">args</span><span class="o">=%</span><span class="i">args</span><span class="o">%</span> <span class="o">%</span><span class="n">1</span>
  <span class="i">shift</span>
  <span class="i">goto</span> <span class="o">:</span><span class="i">parse</span>
)
<span class="k">if</span> <span class="i">defined</span> <span class="i">args</span> <span onmouseout="hideTip(event, 'fs2', 9)" onmouseover="showTip(event, 'fs2', 9)" class="i">set</span> <span class="i">args</span><span class="o">=%</span><span class="i">args</span><span class="o">:</span><span class="k">~</span><span class="n">1</span><span class="o">%</span>


<span class="k">if</span> <span onmouseout="hideTip(event, 'fs3', 10)" onmouseover="showTip(event, 'fs3', 10)" class="i">not</span> <span class="i">exist</span> <span class="s">&quot;%dir%\fck-cmd\packages&quot;</span> (
<span class="i">pushd</span> <span class="s">&quot;%dir%\fck-cmd\&quot;</span>
<span class="s">&quot;</span><span class="o">%</span><span class="i">dir</span><span class="o">%</span>
<span class="i">popd</span> 
)

<span class="k">if</span> <span class="i">exist</span>  <span class="s">&quot;%script%&quot;</span> (
<span class="s">&quot;%dir%/fck-cmd/packages/fake/tools/fake.exe&quot;</span> <span class="s">&quot;%script%&quot;</span> <span class="o">--</span> <span class="o">%</span><span class="i">args</span><span class="o">%</span>
) <span class="k">else</span> <span class="k">if</span> <span class="i">exist</span> <span class="s">&quot;%batch%&quot;</span> (
<span class="i">pushd</span> <span class="s">&quot;%dir%\fck-cmd\&quot;</span>
<span class="s">&quot;</span><span class="o">%</span><span class="i">batch</span><span class="o">%</span><span class="s">&quot; %cmd% %*</span>
<span class="s">popd</span>
<span class="s">) else (</span>
<span class="s">&quot;</span><span class="o">%</span><span class="i">dir</span><span class="o">%/</span><span class="i">fck</span><span class="o">-</span><span class="i">cmd</span><span class="o">/</span><span class="i">packages</span><span class="o">/</span><span class="i">fake</span><span class="o">/</span><span class="i">tools</span><span class="o">/</span><span class="i">fake</span><span class="o">.</span><span class="i">exe</span><span class="s">&quot; &quot;</span><span class="o">%</span><span class="i">dir</span><span class="o">%</span>
)
</code></pre></td>
</tr>
</table>
<p>Forget the paket part for now.</p>
<p>The bash take a command argument, and check whether a fck-cmd/fck-$cmd.fsx file exists.
If it does, run it !
It also works with shell scripts name fck-$cmd.sh or batch scripts fck-$cmd.cmd to integrate quickly with existing tools.</p>
<h2>Fake for faster startups</h2>
<p>When F# scripts start to grow big, especially with things like Json or Xml type providers,
load time can start to raise above acceptable limits for a cli.</p>
<p>Using Fake to launch scripts takes adventage of it's compilation cache. We get the best of both world:</p>
<ul>
<li>scriptability for quick changes and easy deployment</li>
<li>automaticly cached jit compilation for fast startup and execution</li>
</ul>
<p>We could have written all commands in a single fsx file and pattern maching on the command name,
but once we start to have more commands, the script becomes bigger and compilation longer.
The problem is also that the pattern matching becomes a friction point in the source control.</p>
<h2>FckLib</h2>
<p>At some point we have recuring code in the tools. So we can create helper scripts that will be included by
command scripts.</p>
<p>For instance parsing the command line is often useful so I created a helper:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// culture invariant, case insensitive string comparison</span>
<span class="c">let (==) x y = String.Equals(x,y, StringComparison.InvariantCultureIgnoreCase)</span>

<span class="c">open System.Xml.Linq</span>

<span class="c">module CommandLine =</span>
<span class="c">    // get the command line, fck style...</span>
<span class="c">    let getCommandLine() = </span>
<span class="c">        System.Environment.GetCommandLineArgs() </span>
<span class="c">        |&gt; Array.toList</span>
<span class="c">        |&gt; List.skipWhile ((&lt;&gt;) &quot;--&quot;)</span>
<span class="c">        |&gt; List.tail</span>

<span class="c">    // check whether the command line starts with specified command</span>
<span class="c">    let (|Cmd|_|) str cmdLine =</span>
<span class="c">        match cmdLine with</span>
<span class="c">        | s :: _ when s == str -&gt; Some()</span>
<span class="c">        | _ -&gt; None </span>
</code></pre></td>
</tr>
</table>
<p>We use the <code>--</code> to delimit arguments reserved for the script.
Since Fake is used to launch scripts, we can also include FakeLib for all the fantastic helpers it contains.</p>
<p>Here is a sample fck-cmd/fck-hello.fsx script that can write hello.</p>
<p>It uses FakeLib for the <code>tracefn</code> function and FckLib for <code>getCommandLine</code>.</p>
<p>You can call it with (once fck is in your Path environment variable):</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">fck</span> <span class="i">hello</span> <span class="i">Santa</span>
</code></pre></td>
</tr>
</table>
<h2>Help</h2>
<p>A tool without help is just a nightmare, and writing help should be easy.</p>
<p>The last part of fck bash script lanch the fck-help.fsx script:</p>
<p>This script tries to find a fck-xxx.txt file and display it, or fallbacks to fck-help.txt.</p>
<p>For exemple the help for our fck hello command will be in fck-hello.txt:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Usage</span><span class="o">:</span>
<span class="i">fck</span> <span class="i">hello</span> [&lt;<span class="i">name</span>&gt;]

<span class="i">Display</span> <span class="i">a</span> <span class="i">friendly</span> <span class="i">message</span> <span class="k">to</span> <span class="o">&lt;</span><span class="i">name</span><span class="o">&gt;</span> <span class="k">or</span> <span class="k">to</span> <span class="i">you</span> <span class="k">if</span> <span class="o">&lt;</span><span class="i">name</span><span class="o">&gt;</span> <span class="i">is</span> <span class="i">omitted</span><span class="o">.</span>
</code></pre></td>
</tr>
</table>
<p>Of course we can the pimp the fck-help.fsx to parse the txt help files and add codes for colors, verbosity etc.</p>
<h2>Deployment</h2>
<p>Deployment is really easy. We can clone the git repository, and add it to $PATH.</p>
<p>Run the commands, it will automatically restore packages if missing, and lanch the script.</p>
<p>To upgrade to a new version, call fck update, defined in fck-update.sh :</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">script</span><span class="o">=$</span>(<span class="i">readlink</span> <span class="o">-</span><span class="i">f</span> <span class="s">&quot;$0&quot;</span>)
<span class="i">dir</span><span class="o">=$</span>(<span class="i">dirname</span> <span class="o">$</span><span class="i">script</span>)

<span class="i">pushd</span> <span class="s">&quot;$dir&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="i">dev</span><span class="o">/</span><span class="k">null</span>
<span class="i">git</span> <span class="i">pull</span>
<span class="i">mono</span> <span class="s">&quot;$dir/.paket/paket.bootstrapper.exe&quot;</span> <span class="o">--</span><span class="i">run</span> <span class="i">restore</span>
<span class="i">popd</span> <span class="o">&gt;</span> <span class="o">/</span><span class="i">dev</span><span class="o">/</span><span class="k">null</span>
</code></pre></td>
</tr>
</table>
<p>or batch fck-update.cmd:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">git</span> <span class="i">pull</span>
<span class="o">.</span><span class="i">paket</span>
</code></pre></td>
</tr>
</table>
<p>Yep, that's that easy</p>
<h2>Happy Christmas</h2>
<p>Using Santa's elves tools, I hope you won't be stuck at work on xmas eve ! Enjoy !</p>
<p><a href="https://github.com/thinkbeforecoding/fck">The full source is on github</a></p>


<div class="tip" id="fs1">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs2">val set : elements:seq&lt;&#39;T&gt; -&gt; Set&lt;&#39;T&gt; (requires comparison)<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.set</div>
<div class="tip" id="fs3">val not : value:bool -&gt; bool<br /><br />Full name: Microsoft.FSharp.Core.Operators.not</div>